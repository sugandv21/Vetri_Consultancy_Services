{% extends "accounts/base.html" %}
{% block content %}



<div class="container mt-4">

<h2 class="mb-4">My Dashboard</h2>

<!-- PLAN BADGE -->
<div class="mb-3 text-end">
  <span class="badge bg-dark">{{ plan|title }} Plan</span>
</div>

<!-- NOTIFICATIONS -->
{% if notifications %}
<div class="alert alert-info">
<strong>Updates:</strong>
<ul class="mb-0">
{% for n in notifications %}
<li>{{ n.message }}</li>
{% endfor %}
</ul>
</div>
{% endif %}

<!-- MAIN CARDS -->
<div class="row g-4">

<!-- Saved Jobs -->
<div class="col-12 col-md-6 col-lg-4">
  <div class="card text-center shadow-sm h-100 border-danger">
    <div class="card-body bg-danger bg-opacity-10">
      
      <h5 class="text-danger">Saved Jobs</h5>

      <p class="fw-bold fs-1 text-danger">
        {{ saved_jobs_count }}
      </p>

      <a href="{% url 'saved_jobs' %}" 
         class="btn btn-outline-danger btn-sm">
        View
      </a>

    </div>
  </div>
</div>


<!-- Applications -->
<div class="col-12 col-md-6 col-lg-4">
<div class="card text-center shadow-sm h-100 border-success">
<div class="card-body bg-success bg-opacity-10">
<h5 class="text-success">Jobs Applied</h5>

<p class="fw-bold fs-1 text-success">
{% if plan == "FREE" %}
  {{ applications_count }} / 20
{% elif plan == "PRO" %}
  {{ applications_count }} / 100
{% else %}
  {{ applications_count }}
{% endif %}
</p>

<a href="{% url 'applications' %}" class="btn btn-outline-success btn-sm">View</a>
</div>
</div>
</div>

<!-- Interviews -->
<div class="col-12 col-md-6 col-lg-4">
<div class="card text-center shadow-sm h-100 border-info">
<div class="card-body bg-info bg-opacity-10">
<h5 class="text-info">Interviews Scheduled</h5>
<p class="fw-bold fs-1 text-info">{{ interviews_count }}</p>
<p class="fw-bold fs-5 text-info">Upcoming</p>
</div>
</div>
</div>

<!-- Resume Optimization -->
<div class="col-12 col-md-6 col-lg-4">
<div class="card text-center shadow-sm h-100 border-secondary">
<div class="card-body bg-secondary bg-opacity-10">
<h5 class="text-secondary">Resume Optimization</h5>

{% if plan == "FREE" %}
<a href="{% url 'settings' %}" class="btn btn-warning btn-sm">
Upgrade to Continue
</a>

{% elif plan == "PRO" %}
{% if resume_used >= 1 %}
Used — <a href="{% url 'settings' %}">Upgrade to Pro Plus</a>
{% else %}
Available (1 left)
{% endif %}

{% else %}
Used {{ resume_used }} times
{% endif %}

</div>
</div>
</div>

<!-- Consultation -->
<div class="col-12 col-md-6 col-lg-4">
<div class="card text-center shadow-sm h-100 border-dark">
<div class="card-body bg-dark bg-opacity-10">
<h5 class="text-dark">Consultant Sessions</h5>

{% if plan == "FREE" %}
<a href="{% url 'settings' %}" class="btn btn-warning btn-sm">
Upgrade to Continue
</a>

{% elif plan == "PRO" %}
{% if sessions_used >= 1 %}
Used — <a href="{% url 'settings' %}">Upgrade to Pro Plus</a>
{% else %}
Available (1 left)
{% endif %}

{% else %}
Used {{ sessions_used }} sessions
{% endif %}

<br><br>
<a href="{% url 'my_sessions' %}" class="btn btn-outline-secondary btn-sm">
View My Sessions
</a>

</div>
</div>
</div>

<!-- Trainings -->
<div class="col-12 col-md-6 col-lg-4">
<div class="card text-center shadow-sm h-100 border-warning">
<div class="card-body bg-warning bg-opacity-10">
<h5 class="text-warning">Trainings Enrolled</h5>
<p class="fw-bold fs-1 text-warning">{{ enrolled_trainings_count }}</p>
<a href="{% url 'training_list' %}" class="btn btn-outline-warning btn-sm">View</a>
</div>
</div>
</div>

</div>

<!-- PROFILE COMPLETION -->
<div class="card mt-4 shadow-sm border-0 profile-card">
    <div class="card-body">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">
                <i class="bi bi-person-check-fill text-success me-2"></i>
                Profile Completion
            </h5>

            <span class="badge rounded-pill px-3 py-2
                {% if completion < 40 %} bg-danger
                {% elif completion < 80 %} bg-warning text-dark
                {% else %} bg-success
                {% endif %}">
                {{ completion }}%
            </span>
        </div>

        <!-- Progress Bar -->
        <div class="progress rounded-pill" style="height: 14px;" role="progressbar"
             aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">

            <div class="progress-bar progress-bar-striped progress-bar-animated
                {% if completion < 40 %} bg-danger
                {% elif completion < 80 %} bg-warning
                {% else %} bg-success
                {% endif %}"
                style="width: 0%"
                data-width="{{ completion }}">
            </div>

        </div>

        <!-- Status Text -->
        <small class="text-semibold d-block mt-2 fs-5">
            {% if completion < 40 %}
                Your profile needs more details to be visible to others.
            {% elif completion < 80 %}
                Good! Add a few more details to complete your profile.
            {% else %}
                Excellent! Your profile is fully optimized 
            {% endif %}
        </small>

    </div>
</div>


<!-- SKILLS MILESTONE 
<div class="card mt-4 shadow-sm">
<div class="card-body">
<h5>Skill Milestone</h5>
<p class="text-muted">Keep applying & learning to unlock badges.</p>
</div>
</div>-->

<!-- APPLICATION RESPONSE (PRO PLUS ONLY) -->
<div class="card mt-4 shadow-sm">
<div class="card-body">

<h5>Application Response Analytics</h5>

{% if plan == "PRO_PLUS" %}

<canvas id="responseChart"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){

    const labels = {{ chart_labels|safe }};
    const dataValues = {{ chart_data|safe }};

    console.log("Labels:", labels);
    console.log("Data:", dataValues);

    if(labels.length === 0){
        labels.push("Week 1","Week 2","Week 3","Week 4");
        dataValues.push(0,0,0,0);
    }

    const ctx = document.getElementById('responseChart').getContext('2d');

    new Chart(ctx,{
        type:'line',
        data:{
            labels: labels,
            datasets:[{
                label:'Application Status Response',
                data: dataValues,
                borderWidth:2,
                tension:0.3,
                fill:false
            }]
        },
        options:{
            responsive:true,
            scales:{
                y:{
                    beginAtZero:true,
                    ticks:{ precision:0 }
                }
            }
        }
    });

});
</script>


{% else %}

<div class="text-center p-5 locked">
<h6>Available in Pro Plus</h6>
<a href="{% url 'settings' %}" class="btn btn-warning mt-2">
Upgrade to Unlock
</a>
</div>

{% endif %}

</div>
</div>


<h4 class="mt-5 fw-semibold"  id="my-trainings">
    <i class="bi bi-journal-richtext me-2 text-primary fs-1"></i>
    My Trainings
</h4>

<div class="card shadow-sm border-0 mt-3">
<div class="card-body p-0">

<div class="table-responsive">
<table class="table align-middle modern-table mb-0">

<thead class="table-light">
<tr>
<th>Training</th>
<th>Mentor</th>
<th>Session</th>
<th>Join</th>
<th>Certificate</th>
</tr>
</thead>

<tbody>
{% for e in enrollments %}
<tr class="training-row">

<!-- TRAINING -->
<td data-label="Training">
    <div class="fw-semibold">{{ e.training.title }}</div>

    {% if e.is_completed %}
        <span class="badge bg-success-subtle text-success">Completed</span>
    {% elif e.training_link %}
        <span class="badge bg-primary-subtle text-primary">Live</span>
    {% else %}
        <span class="badge bg-secondary-subtle text-secondary">Upcoming</span>
    {% endif %}
</td>

<!-- MENTOR -->
<td data-label="Mentor">
    <div class="d-flex align-items-center gap-2">
        <div class="mentor-avatar">
            {{ e.mentor_name|default:"?"|first|upper }}
        </div>
        <div>
            <div class="fw-medium">
                {{ e.mentor_name|default:"Not assigned" }}
            </div>
            <small class="text-muted">{{ e.mentor_email }}</small>
        </div>
    </div>
</td>

<!-- TIMING -->
<td data-label="Session">
    <i class="bi bi-clock me-1 text-muted"></i>
    {{ e.course_timing|default:"To be announced" }}
</td>

<!-- JOIN BUTTON -->
<td data-label="Join">
{% if e.training_link %}
    <a href="{{ e.training_link }}" target="_blank"
       class="btn btn-sm btn-primary rounded-pill px-3">
       <i class="bi bi-camera-video me-1"></i> Join
    </a>
{% else %}
    <span class="text-muted">Not shared</span>
{% endif %}
</td>

<!-- CERTIFICATE -->
<td data-label="Certificate">
{% if not e.is_completed %}
    <span class="badge bg-light text-muted border">
        After completion
    </span>

{% elif e.is_completed and not e.certificate %}
    <span class="badge bg-warning-subtle text-warning">
        Uploading soon
    </span>

{% else %}
    <a href="{{ e.certificate.url }}"
       class="btn btn-sm btn-success rounded-pill px-3">
       <i class="bi bi-download me-1"></i> Download
    </a>
{% endif %}
</td>

</tr>

{% empty %}
<tr>
<td colspan="5">
    <div class="text-center py-5 empty-state">
        <i class="bi bi-mortarboard display-6 text-muted"></i>
        <p class="mt-3 text-muted">You haven't enrolled in any trainings yet</p>
    </div>
</td>
</tr>
{% endfor %}
</tbody>

</table>
</div>
</div>
</div>


</div>
<style>
/* Mobile-only table stacking */
/* MOBILE TRAINING TABLE FIX */
@media (max-width: 767px) {

  .modern-table thead {
    display: none;
  }

  .modern-table,
  .modern-table tbody,
  .modern-table tr,
  .modern-table td {
    display: block;
    width: 100%;
  }

  .modern-table tr {
    margin-bottom: 14px;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 12px;
    background: #fff;
  }

  .modern-table td {
    border: none !important;
    padding: 6px 0;
  }

  .modern-table td::before {
    content: attr(data-label);
    font-weight: 600;
    display: block;
    font-size: 13px;
    color: #6c757d;
    margin-bottom: 2px;
  }
}


.locked{
  opacity:.35;
  pointer-events:none;
}

{% comment %} saved Jobs {% endcomment %}
.dash-card{
    border:2px solid #003b44;
    border-radius:12px;
    transition:.25s;
    font-size:36px;
}

.dash-card:hover{
    transform:translateY(-5px);
    box-shadow:0 10px 25px #1d809455;
}

.dash-icon{
    width:36px;
    height:36px;
    border-radius:50%;
    background:#e6f4f6;
    padding:6px;
}

.big-number{
    font-size:42px;
    font-weight:700;
    color:#003b44;
}

.btn-dash{
  background:#003b44;
    color:white;
   
}
.btn-dash:hover{
     border:1px solid #003b44;
    color:#003b44;
}

.profile-card {
    border-radius: 16px;
}

.profile-card .progress {
    background-color: #f1f3f5;
    overflow: hidden;
}

.profile-card .progress-bar {
    transition: width 1.2s ease-in-out;
    font-weight: 600;
}

.profile-card h5 {
    font-weight: 600;
}

{% comment %} training {% endcomment %}
 .modern-table tbody tr {
    transition: background .2s ease, box-shadow .2s ease;
    position: relative;
}

/* SAFE hover effect */
.modern-table tbody tr:hover {
    background: #f8fafc;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.015);
}

/* Mentor avatar */
.mentor-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: linear-gradient(135deg,#4f46e5,#22c55e);
    color: white;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

/* Empty state */
.empty-state i {
    opacity: .6;
}

.badge {
    font-weight: 500;
}

</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".progress-bar").forEach(bar => {
        let width = bar.getAttribute("data-width");
        setTimeout(() => {
            bar.style.width = width + "%";
        }, 200);
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function(){

    const params = new URLSearchParams(window.location.search);
    if(params.get("section")==="trainings"){
        const el = document.getElementById("my-trainings");
        if(el){
            setTimeout(()=>{
                el.scrollIntoView({behavior:"smooth", block:"start"});
            }, 250);
        }
    }

});
</script>

{% endblock %}
