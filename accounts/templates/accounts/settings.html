{% extends "accounts/base.html" %}
{% block content %}

<h3 class="mb-4">Account Settings</h3>
{% if upgrade_message %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
  {{ upgrade_message }} <strong>Please upgrade to continue.</strong>
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- ACCOUNT INFO -->
<div class="card mb-4">
  <div class="card-body">
    <h6>Account Information</h6>

    <p><strong>Email:</strong> {{ user.email }}</p>

    <!-- PLAN DISPLAY -->
    <div class="mb-2">
      <strong>Current Plan:</strong>

      <span class="badge 
        {% if user.plan == 'FREE' %}bg-secondary
        {% elif user.plan == 'PRO' %}bg-info
        {% elif user.plan == 'PRO_PLUS' %}bg-success
        {% endif %}
      ">
        {{ user.plan }}
      </span>

      <span class="badge 
        {% if user.plan_status == 'ACTIVE' %}bg-success
        {% elif user.plan_status == 'EXPIRED' %}bg-danger
        {% else %}bg-warning text-dark
        {% endif %}
      ">
        {{ user.plan_status }}
      </span>
    </div>

    <!-- EXPIRY DATE -->
    {% if user.plan != 'FREE' and user.plan_end %}
      <p class="text-muted small mb-2">
        Valid till: {{ user.plan_end|date:"M d, Y" }}
      </p>
    {% endif %}

    <!-- EXPIRED MESSAGE -->
    {% if user.plan_status == 'EXPIRED' %}
      <div class="alert alert-warning py-2">
        Your subscription expired. Upgrade to continue premium features.
      </div>
    {% endif %}

    <!-- UPGRADE BUTTONS -->
    <div class="mt-2">
      {% if user.plan == 'FREE' %}
        <a href="{% url 'upgrade_to_pro' %}" class="btn btn-primary btn-sm">
          Upgrade to Pro
        </a>

        <a href="{% url 'upgrade_to_pro_plus' %}" class="btn btn-dark btn-sm">
          Go Pro Plus
        </a>

      {% elif user.plan == 'PRO' %}
        <a href="{% url 'upgrade_to_pro_plus' %}" class="btn btn-dark btn-sm">
          Upgrade to Pro Plus
        </a>
      {% endif %}
    </div>

  </div>
</div>

<!-- CHANGE PASSWORD -->
<div class="card">
  <div class="card-body">
    <h6>Change Password</h6>

    <form method="post">
      {% csrf_token %}

      <div class="mb-3">
        <input type="password" class="form-control"
               name="new_password" placeholder="New Password">
      </div>

      <div class="mb-3">
        <input type="password" class="form-control"
               name="confirm_password" placeholder="Confirm Password">
      </div>

      <button class="btn btn-warning">Update Password</button>
    </form>
  </div>
</div>
<!-- BILLING & PAYMENTS -->
<div class="card mt-4">
  <div class="card-body">
    <h6 class="mb-3">Billing & Payments</h6>

    {% if payments %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Invoice</th>

          </tr>
        </thead>
        <tbody>

        {% for p in payments %}
        <tr>
          <!-- DATE -->
          <td>{{ p.created_at|date:"M d, Y" }}</td>

          <!-- CATEGORY -->
          <td>
            {% if p.payment_type == "PLAN" %}
              <span class="badge bg-primary">Subscription</span>
            {% else %}
              <span class="badge bg-info text-dark">Training</span>
            {% endif %}
          </td>

          <!-- DESCRIPTION -->
          <td>
            {% if p.payment_type == "PLAN" %}
              Plan Upgrade ({{ user.plan }})
            {% elif p.training %}
              {{ p.training.title }}
              {% if p.amount == 0 %}
                <div class="small text-success">PRO PLUS Complimentary Training</div>
              {% endif %}
            {% else %}
              Training Purchase
            {% endif %}
          </td>

          <!-- AMOUNT -->
          <td>
            {% if p.amount == 0 %}
              <span class="text-success fw-semibold">FREE</span>
            {% else %}
              â‚¹{{ p.amount }}
            {% endif %}
          </td>

          <!-- STATUS -->
          <td>
            {% if p.status == "SUCCESS" %}
              <span class="badge bg-success">Success</span>
            {% else %}
              <span class="badge bg-danger">Failed</span>
            {% endif %}
          </td>

          <td>
  {% if p.status == "SUCCESS" %}
    <a href="{% url 'download_invoice' p.id %}" class="btn btn-sm btn-outline-primary">
      Download
    </a>
  {% else %}
    -
  {% endif %}
</td>

        </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>
    {% else %}
      <p class="text-muted">No transactions yet.</p>
    {% endif %}
  </div>
</div>


{% comment %} {% if user.is_staff %}
<span class="badge bg-dark">ADMIN</span>
{% endif %} {% endcomment %}

{% endblock %}
